using UnityEngine;
using System.Collections;

public class BitPet : MonoBehaviour {

	private float speed;
	public float CHASE_SPEED = 0.085f;
	public float REST_SPEED = 0.02f;
	public float REST_DISTANCE = 1.5f;
	public float CHASE_DISTANCE = 4.5f;

	private bool wait;
	public bool attacking;

	public Vector3 near;
	public Player hero = null;
	public DialogueNodeBIT dialogue = null;
	// Use this for initialization
	void Start () {
		hero = GameObject.Find ("Player").GetComponent<Player>();
		dialogue = GameObject.Find ("Dialogue1").GetComponent<DialogueNodeBIT>();
		speed = 0.1f;
		wait = true;
		dialogue.dialogueStart (transform.position);
		near = new Vector3 ();
	}
	
	// Update is called once per frame
	void Update () {
		float distance = Vector3.Distance (hero.transform.position, transform.position);

		if (wait){
			if (Input.GetKeyDown(KeyCode.Space) && distance < REST_DISTANCE + 5f){
				wait = !wait;
			}
			return;
		}

		if (!Player.Instance.isBeingAttacked){
			attacking = false;
			dialogue.dialogueStart(transform.position);
		}
		Vector3 newdir;
		if (!attacking){
			if (distance > CHASE_DISTANCE * 2f){
				speed = CHASE_SPEED * 2f;
			}else if(distance > CHASE_DISTANCE){
				speed = CHASE_SPEED;
			} else if (distance >= REST_DISTANCE) {
				speed = REST_SPEED;
			}else {
				speed = 0;
			}
			newdir = new Vector3(hero.transform.position.x, hero.transform.position.y + 0.5f, 0f);
		}else {
			speed = CHASE_SPEED * 3f;
			newdir = new Vector3(near.x, near.y, 0f);
			dialogue.finish();
		}

		transform.position = Vector3.MoveTowards(transform.position, newdir, speed);
	}

	void OnTriggerEnter2D(Collider2D other){
		if (attacking)
				return;
		if (Player.Instance.isBeingAttacked && (
            other.gameObject.name == "Worm" || 
            other.gameObject.name == "Trojan" || 
            other.gameObject.name == "Spyware" || 
            other.gameObject.name == "CorruptedFile" || 
            other.gameObject.name == "Worm(Clone)" || 
            other.gameObject.name == "Trojan(Clone)" ||
            other.gameObject.name == "Spyware(Clone)" || 
            other.gameObject.name == "CorruptedFile(Clone)"))
        {
			//Enemy.enemies.Find(other.transform.parent.gameObject.GetType());
			attacking = true;
			near = other.transform.position;
		}
	}

	void OnTriggerStay2D(Collider2D other){
		if (attacking)
				return;
        if (Player.Instance.isBeingAttacked && (
            other.gameObject.name == "Worm" ||
            other.gameObject.name == "Trojan" ||
            other.gameObject.name == "Spyware" ||
            other.gameObject.name == "CorruptedFile" ||
            other.gameObject.name == "Worm(Clone)" ||
            other.gameObject.name == "Trojan(Clone)" ||
            other.gameObject.name == "Spyware(Clone)" ||
            other.gameObject.name == "CorruptedFile(Clone)"))
        {
			attacking = true;
			near = other.transform.position;
		}
	}
}
